{% extends "base.html" %}
{% load static %}
{% load product_tags %}
{% block content %}
<style>
  .basket-btn {
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  .basket-btn.added {
    background-color: var(--primary-red);
  }
  .basket-btn.added svg {
    stroke: white;
  }
  .buy-button {
    background-color: var(--primary);
    transition: background-color 0.3s ease;
  }
  .buy-button:hover {
    background-color: var(--primary-dark);
  }
  .error-message {
    color: #dc2626;
    text-align: center;
    margin-bottom: 1rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    display: none;
  }
  .success-message {
    color: #15803d;
    text-align: center;
    margin-bottom: 1rem;
    padding: 0.5rem;
    background-color: #dcfce7;
    border-radius: 0.5rem;
    display: none;
  }
  #orderModal {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  #orderModal.hidden {
    display: none;
  }
  .modal-content {
    background-color: white;
    border-radius: 1rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 28rem;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .modal-content .p-6 {
    flex: 1;
    overflow: hidden;
  }
  body.modal-open {
    overflow: hidden;
  }
  .quantity-controls {
    display: inline-flex;
    align-items: center;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    background-color: white;
  }
  .quantity-btn {
    background: none;
    border: none;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1.125rem;
  }
  .quantity-btn:hover {
    background-color: #f3f4f6;
    color: #374151;
  }
  .quantity-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .quantity-display {
    padding: 0 1rem;
    font-weight: 600;
    color: #111827;
    min-width: 3rem;
    text-align: center;
  }
</style>
<main class="pt-32 pb-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    {% if error %}
    <div class="{% if error|slice:":4" == "–¢–æ–≤–∞—Ä" %}success-message{% else %}error-message{% endif %}" style="display: block;">
      {{ error }}
    </div>
    {% endif %}
    {% if product_one %}
    <div class="product-card rounded-2xl shadow-xl p-4 lg:p-6">
      <div class="grid lg:grid-cols-2 gap-6 lg:gap-10 items-center">
        <div class="space-y-3">
          <div class="product-image-container rounded-2xl p-4 relative overflow-hidden">
            {% if product_one.images.exists %}
              <img
                id="mainImage-{{ product_one.id }}"
                src="{{ product_one.images.first.image.url }}"
                alt="{{ product_one|get_name_by_lang:lang }}"
                class="w-full h-auto max-w-md mx-auto drop-shadow-2xl animate-float"
              />
            {% else %}
              <div class="w-full h-auto max-w-md mx-auto flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 380 260" class="w-full h-full max-h-64">
                  <defs>
                    <linearGradient id="wiper{{ product_one.id }}" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" style="stop-color:#667eea;stop-opacity:0.8"/>
                      <stop offset="50%" style="stop-color:#764ba2;stop-opacity:0.9"/>
                      <stop offset="100%" style="stop-color:#667eea;stop-opacity:0.8"/>
                    </linearGradient>
                  </defs>
                  <rect x="40" y="120" width="300" height="12" rx="6" fill="url(#wiper{{ product_one.id }})"/>
                  <rect x="40" y="140" width="280" height="8" rx="4" fill="#667eea" opacity="0.6"/>
                  <circle cx="50" cy="126" r="8" fill="#764ba2"/>
                  <circle cx="330" cy="126" r="8" fill="#764ba2"/>
                  <circle cx="50" cy="126" r="3" fill="white"/>
                  <circle cx="330" cy="126" r="3" fill="white"/>
                </svg>
              </div>
            {% endif %}
          </div>
          
          <!-- {% if product_one.images.exists %}
            <div class="flex space-x-3 justify-center">
              {% for image in product_one.images.all %}
              <button
                data-product="{{ product_one.id }}"
                data-slide="{{ forloop.counter0 }}"
                class="thumbnail-btn w-18 h-16 rounded-lg border-2 overflow-hidden {% if forloop.first %}border-primary{% else %}border-gray-300{% endif %}"
              >
                <img
                  src="{{ image.image.url }}"
                  alt="Thumbnail {{ forloop.counter }}"
                  class="w-full h-full object-cover"
                />
              </button>
              {% endfor %}
            </div>
          {% endif %} -->
        </div>
        
        <div class="space-y-5">
          <div>
            <div class="inline-block px-3 py-1 bg-primary/10 text-primary rounded-full text-sm font-medium mb-3">
              {{ product_one.brand.name }}
            </div>
            <h1 class="text-2xl lg:text-4xl font-bold text-gray-900 mb-4">
              {{ product_one|get_name_by_lang:lang }}
            </h1>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-3xl lg:text-4xl font-bold text-gray-900">
              {{ product_one.get_price_with_icon }}
            </span>
            <!-- <span class="text-xl text-gray-400 line-through">
              {{ product_one.get_price_original_with_icon }}
            </span> -->
            <!-- <div class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-sm font-semibold">
              -{{ product_one.discount }}%
            </div> -->
          </div>
          <div class="bg-gray-50 rounded-xl p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-3" data-translate="product_description">
              –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
            </h3>
            <p class="text-gray-700 leading-relaxed mb-3">
              {{ product_one|get_description_by_lang:lang }}
            </p>
          </div>
          <div class="flex items-center gap-4 pt-3">
            <button
              class="buy-button flex-1 px-4 sm:px-6 lg:px-8 py-3 text-white font-semibold rounded-lg text-sm sm:text-base lg:text-lg shadow-lg"
              onclick="openOrderModal()"
              data-translate="buy_now"
            >
              –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å
            </button>
            {% if product_one|is_in_cart:request.user %}
            <a
              href="{% url 'cart-remove' remove_id=product_one.id %}"
              class="basket-btn flex items-center justify-center w-12 h-12 rounded-lg border border-gray-300 hover:bg-red-600 added"
              title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã"
              data-translate-title="remove_from_cart"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
            </a>
            {% else %}
            <form action="{% url 'cart-add' add_id=product_one.id %}" method="post">
              {% csrf_token %}
              <button
                type="submit"
                class="basket-btn flex items-center justify-center w-12 h-12 rounded-lg border border-gray-300 hover:bg-gray-50"
                title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É"
                data-translate-title="add_to_cart"
              >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
              </button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="feature-card rounded-xl p-6 text-center">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
          </svg>
        </div>
        <h3 class="font-semibold text-gray-900 mb-2" data-translate="convenient_purchase">
          –£–¥–æ–±–Ω–æ –ö—É–ø–∏—Ç—å
        </h3>
        <p class="text-gray-600 text-sm" data-translate="convenient_purchase_description">
          –õ–µ–≥–∫–æ –∏ –±—ã—Å—Ç—Ä–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </p>
      </div>
      <div class="feature-card rounded-xl p-6 text-center">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
          </svg>
        </div>
        <h3 class="font-semibold text-gray-900 mb-2" data-translate="quality_guarantee">
          –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
        </h3>
        <p class="text-gray-600 text-sm" data-translate="quality_guarantee_description">
          –í—Å–µ —Ç–æ–≤–∞—Ä—ã –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ
        </p>
      </div>
      <div class="feature-card rounded-xl p-6 text-center">
        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
          </svg>
        </div>
        <h3 class="font-semibold text-gray-900 mb-2" data-translate="reliable_partner">
          –ù–∞–¥–µ–∂–Ω—ã–π –ü–∞—Ä—Ç–Ω–µ—Ä
        </h3>
        <p class="text-gray-600 text-sm" data-translate="reliable_partner_description">
          –í–∞—à –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä –≤ –º–∏—Ä–µ –∞–≤—Ç–æ —Ç–æ–≤–∞—Ä–æ–≤
        </p>
      </div>
    </div>
    {% else %}
    <div class="text-center py-12">
      <h3 class="text-xl font-semibold text-gray-900 mb-2" data-translate="no_products_found">
        –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
      </h3>
    </div>
    {% endif %}
  </div>
  
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900" data-translate="order_checkout">
            –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
          </h2>
          <button
            id="closeOrderModalBtn"
            class="text-gray-400 hover:text-gray-600 transition-colors"
            onclick="closeOrderModal()"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
          <h3 id="modalProductName" class="font-semibold text-gray-900 mb-2">
            {{ product_one|get_name_by_lang:lang }}
          </h3>
          <div class="flex justify-between items-center text-sm text-gray-600">
            <div class="flex items-center gap-2">
              <span data-translate="quantity_label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
              <div class="quantity-controls">
                <button
                  type="button"
                  class="quantity-btn"
                  onclick="updateQuantity(-1)"
                  id="decreaseBtn"
                >
                  ‚àí
                </button>
                <span class="quantity-display" id="quantity">1</span>
                <button
                  type="button"
                  class="quantity-btn"
                  onclick="updateQuantity(1)"
                  id="increaseBtn"
                >
                  +
                </button>
              </div>
            </div>
            <span id="modalPrice" class="font-bold text-lg text-gray-900">
              {{ product_one.get_price_with_icon }}
            </span>
          </div>
        </div>
        <form id="orderForm" action="{% url 'order_create' %}" method="post" class="space-y-4">
          {% csrf_token %}
          <input type="hidden" id="productId" name="productId" value="{{ product_one.id }}" />
          <input type="hidden" id="productName" name="productName" value="{{ product_one|get_name_by_lang:lang }}" />
          <input type="hidden" id="productPrice" name="productPrice" value="{{ product_one.get_price }}" />
          <input type="hidden" id="productBrand" name="productBrand" value="{{ product_one.brand.name }}" />
          <input type="hidden" id="productQuantity" name="productQuantity" value="1" />
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="full_name">
              –ü–æ–ª–Ω–æ–µ –∏–º—è *
            </label>
            <input
              type="text"
              name="fullName"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              data-translate-placeholder="name_placeholder"
            />
          </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="phone_number">
              –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *
            </label>
            <input
              id="contactPhone"
              type="tel"
              name="phone"
              placeholder="+998 (XX) XXX-XX-XX"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              data-translate-placeholder="phone_placeholder"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="email">
              Email *
            </label>
            <input
              type="email"
              name="email"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              data-translate-placeholder="email"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="additional_info">
              –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            </label>
            <textarea
              name="additionalInfo"
              rows="3"
              placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
              data-translate-placeholder="message_placeholder"
            ></textarea>
          </div>
          <div class="flex gap-3 pt-4">
            <button
              type="button"
              onclick="closeOrderModal()"
              class="max-h-12 max-w-full flex-1 px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors"
              data-translate="cancel"
            >
              –û—Ç–º–µ–Ω–∞
            </button>
            <button
              type="submit"
              class="max-h-12 max-w-full flex-1 px-4 py-2 bg-primary text-white font-semibold rounded-lg hover:bg-primary/90 transition-colors"
              data-translate="send"
            >
              –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Function to get translated text by data-translate attribute
  function getTranslatedText(key) {
    const element = document.querySelector(`[data-translate="${key}"]`);
    return element ? element.textContent || element.innerText : key;
  }

  // Function to send order data to Telegram
  async function sendToTelegram(orderData) {
    const botToken = '8390195291:AAGK2g83t4Oo88CynwMPnyjnbx5zpHQB-6k';
    const chatId = '-1003077427700';
    const message = `üõí *Yangi Buyurtma*\n\n` +
      `üì¶ *–¢–æ–≤–∞—Ä:* ${orderData.productName}\n` +
      `üè¢ *–ë—Ä–µ–Ω–¥:* ${orderData.productBrand}\n` +
      `üí∞ *–¶–µ–Ω–∞:* ${orderData.productPrice} ${orderData.priceType}\n` +
      `üìä *–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:* ${orderData.quantity}\n` +
      `üíµ *–û–±—â–∞—è —Å—É–º–º–∞:* ${(parseFloat(orderData.productPrice) * parseInt(orderData.quantity)).toFixed(0)} ${orderData.priceType}\n\n` +
      `üë§ *–ö–ª–∏–µ–Ω—Ç:*\n` +
      `  *–ò–º—è:* ${orderData.fullName}\n` +
      `  *–¢–µ–ª–µ—Ñ–æ–Ω:* ${orderData.phone}\n` +
      `  *Email:* ${orderData.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n` +
      `  *–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:* ${orderData.additionalInfo || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n\n` +
      `üïí *–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞:* ${new Date().toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent' })}`;

    try {
      const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: chatId,
          text: message,
          parse_mode: 'Markdown'
        })
      });
      return (await response.json()).ok;
    } catch (error) {
      console.error('Telegram error:', error);
      return false;
    }
  }

  // Function to format phone number input
  function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, '');
    if (!value.startsWith('998')) value = '998' + value;
    if (value.length > 12) value = value.substring(0, 12); // Limit to +998 and 9 digits
    let formattedValue = '+998';
    if (value.length > 3) {
      formattedValue += ` (${value.substring(3, 5)}`;
      if (value.length > 5) {
        formattedValue += `) ${value.substring(5, 8)}`;
        if (value.length > 8) {
          formattedValue += `-${value.substring(8, 10)}`;
          if (value.length > 10) {
            formattedValue += `-${value.substring(10, 12)}`;
          }
        }
      }
    }
    input.value = formattedValue;
    return formattedValue;
  }

  let currentQuantity = 1;
  let currentPrice = parseFloat("{{ product_one.get_price }}".replace(/[^\d.]/g, ""));

  window.openOrderModal = () => {
    currentQuantity = 1;
    document.getElementById("quantity").textContent = currentQuantity;
    document.getElementById("productQuantity").value = currentQuantity;
    const phoneInput = document.getElementById("contactPhone");
    if (phoneInput) phoneInput.value = '+998'; // Set default to +998
    updateQuantityButtons();
    updatePrice();
    const orderModal = document.getElementById("orderModal");
    if (orderModal) {
      orderModal.classList.remove("hidden");
      document.body.classList.add("modal-open");
    }
  };

  window.closeOrderModal = () => {
    const orderModal = document.getElementById("orderModal");
    if (orderModal) {
      orderModal.classList.add("hidden");
      document.body.classList.remove("modal-open");
      const orderForm = document.getElementById("orderForm");
      if (orderForm) orderForm.reset();
      const phoneInput = document.getElementById("contactPhone");
      if (phoneInput) phoneInput.value = '+998';
    }
  };

  window.updateQuantity = (change) => {
    const newQuantity = currentQuantity + change;
    if (newQuantity >= 1) {
      currentQuantity = newQuantity;
      document.getElementById("quantity").textContent = currentQuantity;
      document.getElementById("productQuantity").value = currentQuantity;
      updateQuantityButtons();
      updatePrice();
    }
  };

  function updateQuantityButtons() {
    const decreaseBtn = document.getElementById("decreaseBtn");
    if (decreaseBtn) {
      decreaseBtn.disabled = currentQuantity <= 1;
    }
  }

  function updatePrice() {
    const totalPrice = currentPrice * currentQuantity;
    document.getElementById("modalPrice").textContent = `${totalPrice.toFixed(2)} {{ product_one.price_type }}`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Phone number formatting
    const phoneInput = document.getElementById("contactPhone");
    if (phoneInput) {
      phoneInput.value = '+998'; // Initial value
      phoneInput.addEventListener('input', () => {
        formatPhoneNumber(phoneInput);
      });
      phoneInput.addEventListener('focus', () => {
        if (!phoneInput.value) phoneInput.value = '+998';
      });
    }

    const orderForm = document.getElementById("orderForm");
    if (orderForm) {
      orderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const phoneInput = document.getElementById("contactPhone");

        const submitButton = orderForm.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = getTranslatedText('sending') || '–û—Ç–ø—Ä–∞–≤–∫–∞...';

        try {
          const formData = new FormData(orderForm);
          // Send phone number as clean digits
          formData.set('phone', phoneInput.value.replace(/\D/g, ''));
          const orderData = {
            productName: formData.get('productName'),
            productBrand: formData.get('productBrand'),
            productPrice: formData.get('productPrice'),
            priceType: "{{ product_one.price_type }}",
            quantity: currentQuantity,
            fullName: formData.get('fullName'),
            phone: phoneInput.value.replace(/\D/g, ''),
            email: formData.get('email'),
            additionalInfo: formData.get('additionalInfo')
          };

          // Send to Telegram
          const telegramSuccess = await sendToTelegram(orderData);

          // Send to server
          const response = await fetch("{% url 'order_create' %}", {
            method: 'POST',
            body: formData,
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
              "X-Requested-With": "XMLHttpRequest"
            }
          });
          const data = await response.json();

          if (data.success && telegramSuccess) {
            alert(getTranslatedText('order_success') || '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
            orderForm.reset();
            if (phoneInput) phoneInput.value = '+998';
            closeOrderModal();
          } else {
            alert(getTranslatedText('order_error') || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.');
          }
        } catch (error) {
          console.error("Error:", error);
          alert(getTranslatedText('order_error') || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      });
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeOrderModal();
      }
    });

    // Close modal when clicking outside
    const orderModal = document.getElementById("orderModal");
    if (orderModal) {
      orderModal.addEventListener("click", (e) => {
        if (e.target === orderModal) {
          closeOrderModal();
        }
      });
    }

    // Close modal button
    const closeOrderModalBtn = document.getElementById("closeOrderModalBtn");
    if (closeOrderModalBtn) {
      closeOrderModalBtn.addEventListener("click", closeOrderModal);
    }

    // Thumbnail button handling (if re-enabled)
    const thumbnailButtons = document.querySelectorAll(".thumbnail-btn");
    if (thumbnailButtons.length > 0) {
      thumbnailButtons.forEach((button) => {
        button.addEventListener("click", (event) => {
          const productId = button.getAttribute("data-product");
          const slideIndex = button.getAttribute("data-slide");
          const mainImage = document.getElementById(`mainImage-${productId}`);
          const newImageSrc = button.querySelector("img").src;
          mainImage.src = newImageSrc;
          thumbnailButtons.forEach((btn) => {
            btn.classList.remove("border-primary");
            btn.classList.add("border-gray-300");
          });
          button.classList.remove("border-gray-300");
          button.classList.add("border-primary");
        });
      });
    }
  });
</script>
{% endblock %}

{% block scripts %}
    <script src="{% static 'script/productDetails.js' %}"></script>
{% endblock scripts %}