{% extends "base.html" %}
{% load static %}
{% load product_tags %}
{% block content %}
  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-28 pb-20">
    <div class="bg-[var(--primary-red)] rounded-xl shadow-lg p-6 mb-2">
      <h1 class="text-lg text-white">
        <span data-translate="basket"></span> <span class="text-sm text-white">{{ basket_count }} <span data-translate="items"></span></span>
      </h1>
    </div>
    <div class="lg:flex lg:space-x-6 space-y-8 lg:space-y-0">
      <div class="lg:w-3/5 bg-white rounded-xl shadow-lg p-5 h-[600px] flex flex-col">
        <div class="flex-1 overflow-y-auto">
          <div class="space-y-5">
            {% for i in carts %}
              <div class="flex flex-col sm:flex-row gap-4 border-b border-gray-200 pb-5">
                {% if i.product.images.first %}
                  <img src="{{ i.product.images.first.image.url }}"
                       alt="{{ i.product|get_name_by_lang:lang }}"
                       class="w-full sm:w-28 h-auto rounded-lg shadow-sm bg-gray-200" />
                {% else %}
                  <img src="{% static 'images/default.png' %}"
                       alt="No image"
                       class="w-full sm:w-28 h-auto rounded-lg shadow-sm bg-gray-200" />
                {% endif %}
                <div class="flex-1 flex flex-col sm:flex-row justify-between">
                  <div class="space-y-1 flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 line-clamp-2">{{ i.product|get_name_by_lang:lang }}</h3>
                    <div class="flex flex-wrap gap-3 text-sm text-gray-600">
                      <span><span data-translate="size"></span>: <span class="font-medium text-gray-800">{{ i.product.size }}</span></span>
                      <span><span data-translate="color"></span>: <span class="font-medium text-gray-800">{{ i.product|get_color_by_lang:lang }}</span></span>
                    </div>
                    <p class="text-lg font-bold text-[var(--primary-red)] mt-2">{{ i.product.get_price_with_icon }}</p>
                  </div>
                  <div class="flex flex-row sm:flex-col justify-between items-center sm:items-end mt-3 sm:mt-0">
                    <a href="{% url 'cart-remove' remove_id=i.product.id %}"
                       class="text-gray-400 hover:text-red-500 transition-colors p-1"
                       aria-label="Remove item">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                      </svg>
                    </a>
                    <div class="flex items-center space-x-2">
                      <button class="text-gray-600 hover:text-[var(--primary-red)] transition-colors p-1 decrease"
                              aria-label="Decrease quantity"
                              onclick="updateQuantity('card_{{ i.id }}', {{ i.id }}, -1)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                        </svg>
                      </button>
                      <span class="text-lg quantity" id="card_{{ i.id }}">{{ i.quantity }}</span>
                      <button class="text-gray-600 hover:text-[var(--primary-red)] transition-colors p-1 increase"
                              aria-label="Increase quantity"
                              onclick="updateQuantity('card_{{ i.id }}', {{ i.id }}, 1)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="pt-4 border-t border-gray-200 mt-auto">
          <a href="{% url 'products' %}">
            <button class="inline-flex items-center text-[var(--primary-red)] hover:text-[var(--primary-dark)] font-medium transition-colors">
              <svg class="w-4 h-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
              <span data-translate="continue_shopping"></span>
            </button>
          </a>
        </div>
      </div>
      <div class="lg:w-2/5 bg-white rounded-xl shadow-lg p-5 h-[600px] flex flex-col">
        <div class="flex flex-col h-full justify-between">
          <div>
            <div class="space-y-3 border-b border-gray-200 pb-4 mb-4">
              <div class="flex justify-between text-lg mb-6">
                <span class="text-gray-900 font-bold" data-translate="total"></span>
                <span id="total_balance" class="font-bold text-gray-900 text-xl">
                  {% if request.user.is_authenticated %}
                    {{ request.user.calculate_cart }}
                  {% else %}
                    0.00
                  {% endif %}
                </span>
              </div>
            </div>
            <form class="space-y-3" id="cartOrderForm">
              {% csrf_token %}
              <input class="w-full py-3 px-4 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-red)] focus:border-transparent text-gray-700"
                     type="text"
                     data-translate-placeholder="full_name"
                     placeholder="Full Name"
                     required />
              <input class="w-full py-3 px-4 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-red)] focus:border-transparent text-gray-700"
                     id="contactPhone"
                     type="tel"
                     data-translate-placeholder="phone_number"
                     placeholder="Phone Number" />
              <input class="w-full py-3 px-4 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-red)] focus:border-transparent text-gray-700"
                     type="email"
                     data-translate-placeholder="email"
                     placeholder="Email Address"
                     required />
              <textarea class="w-full py-3 px-4 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--primary-red)] focus:border-transparent text-gray-700 resize-none h-20"
                        data-translate-placeholder="additional_info"
                        placeholder="Qo'shimcha ma'lumot"></textarea>
              <button type="submit"
                      class="w-full py-3 bg-[var(--primary-red)] text-white rounded-lg font-semibold text-base hover:bg-[var(--primary-dark)] transition-colors shadow-md flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 2L11 13" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 2L15 22l-4-9-9-4 20-9z" />
                </svg>
                <span data-translate="send"></span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>
  <script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function getTranslatedText(key) {
  const element = document.querySelector(`[data-translate="${key}"]`);
  return element ? element.textContent || element.innerText : key;
}

async function sendCartToTelegram(orderData) {
  const botToken = '8390195291:AAGK2g83t4Oo88CynwMPnyjnbx5zpHQB-6k';
  const chatId = '-1003077427700';
  
  let cartItems = '';
  orderData.cartItems.forEach((item, index) => {
    cartItems += `
${index + 1}. <b>${item.name}</b>
   üè¢ –ë—Ä–µ–Ω–¥: ${item.brand || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
   üìè –†–∞–∑–º–µ—Ä: ${item.size}
   üé® –¶–≤–µ—Ç: ${item.color}
   üí∞ –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É: ${item.price}
   üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}
   üíµ –°—É–º–º–∞: ${item.totalPrice}
`;
  });

  const message = `üõí <b>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã</b>

üì¶ <b>–¢–û–í–ê–†–´:</b>${cartItems}

üí∞ <b>–û–ë–©–ê–Ø –°–£–ú–ú–ê:</b> ${orderData.totalAmount}

üë§ <b>–ö–õ–ò–ï–ù–¢:</b>
  <b>–ò–º—è:</b> ${orderData.fullName}
  <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> ${orderData.contactPhone}
  <b>Email:</b> ${orderData.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
  <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</b> ${orderData.additionalInfo || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}

üïí <b>–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞:</b> ${new Date().toLocaleString('ru-RU', {timeZone: 'Asia/Tashkent'})}`;

  try {
    const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: message,
        parse_mode: 'HTML'
      })
    });
    const result = await response.json();
    return result.ok;
  } catch (error) {
    console.error('Telegram error:', error);
    return false;
  }
}

function formatPhoneNumber(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.startsWith('998')) value = value.substring(3);
  
  if (value.length > 0) {
    if (value.length <= 2) {
      value = `+998 (${value}`;
    } else if (value.length <= 5) {
      value = `+998 (${value.substring(0, 2)}) ${value.substring(2)}`;
    } else if (value.length <= 8) {
      value = `+998 (${value.substring(0, 2)}) ${value.substring(2, 5)}-${value.substring(5)}`;
    } else {
      value = `+998 (${value.substring(0, 2)}) ${value.substring(2, 5)}-${value.substring(5, 7)}-${value.substring(7, 9)}`;
    }
  }
  input.value = value;
}

function validatePhone(phoneValue) {
  const phonePattern = /^\+998\s\(\d{2}\)\s\d{3}-\d{2}-\d{2}$/;
  return phonePattern.test(phoneValue);
}

function collectCartData() {
  const cartItems = [];
  
  document.querySelectorAll('.flex.flex-col.sm\\:flex-row.gap-4.border-b').forEach(item => {
    const nameElement = item.querySelector('h3.text-lg.font-semibold');
    const sizeSpan = item.querySelector('[data-translate="size"]');
    const colorSpan = item.querySelector('[data-translate="color"]');
    const priceElement = item.querySelector('.text-lg.font-bold.text-\\[var\\(--primary-red\\)\\]');
    const quantityElement = item.querySelector('.quantity');
    
    if (nameElement && priceElement && quantityElement) {
      const name = nameElement.textContent.trim();
      const price = priceElement.textContent.trim();
      const quantity = parseInt(quantityElement.textContent.trim());
      
      let size = '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
      let color = '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
      
      if (sizeSpan && sizeSpan.parentNode) {
        const sizeText = sizeSpan.parentNode.textContent;
        const sizeMatch = sizeText.match(/Size:\s*(.+?)(?:\s|$)/);
        if (sizeMatch) size = sizeMatch[1].trim();
      }
      
      if (colorSpan && colorSpan.parentNode) {
        const colorText = colorSpan.parentNode.textContent;
        const colorMatch = colorText.match(/Color:\s*(.+?)(?:\s|$)/);
        if (colorMatch) color = colorMatch[1].trim();
      }
      
      const priceMatch = price.match(/[\d\s,]+/);
      const priceValue = priceMatch ? parseFloat(priceMatch[0].replace(/\s/g, '').replace(',', '.')) : 0;
      const totalPrice = (priceValue * quantity).toFixed(0);
      
      cartItems.push({
        name,
        brand: '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        size,
        color,
        price,
        quantity,
        totalPrice: `${totalPrice} UZS`
      });
    }
  });
  
  return cartItems;
}

async function updateQuantity(spanId, id, change) {
  const spanElement = document.getElementById(spanId);
  const totalBalanceElement = document.getElementById("total_balance");
  let quantity = parseInt(spanElement.innerText);

  if (change < 0 && quantity <= 1) {
    alert(getTranslatedText("min_quantity_error"));
    return;
  }

  quantity += change;
  spanElement.innerText = quantity;

  try {
    const url = `/ch/cart/${id}/${change === 1 ? '1' : '0'}/`;
    const response = await fetch(url);

    if (!response.ok) {
      throw new Error(`${getTranslatedText("request_error")}: ${response.status}`);
    }

    const data = await response.json();
    
    if (data.success) {
      totalBalanceElement.innerText = `${data.total_balance}`;
    } else {
      quantity -= change;
      spanElement.innerText = quantity;
      alert(getTranslatedText("update_quantity_error"));
    }
  } catch (error) {
    quantity -= change;
    spanElement.innerText = quantity;
    console.error(`${getTranslatedText("error")}:`, error);
    alert(`${getTranslatedText("error")}: ${error.message}`);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const phoneInput = document.getElementById('contactPhone');
  if (phoneInput) {
    phoneInput.addEventListener('input', () => formatPhoneNumber(phoneInput));
    phoneInput.addEventListener('focus', () => {
      if (!phoneInput.value) phoneInput.value = '+998 (';
    });
  }

  const cartForm = document.getElementById('cartOrderForm');
  if (cartForm) {
    cartForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitButton = cartForm.querySelector('button[type="submit"]');
      const originalHTML = submitButton.innerHTML;
      
      submitButton.disabled = true;
      submitButton.innerHTML = `
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        ${getTranslatedText('sending')}
      `;
      
      try {
        const cartItems = collectCartData();
        const totalAmount = document.getElementById('total_balance').textContent.trim();
        
        if (cartItems.length === 0) {
          alert(getTranslatedText('empty_cart_error'));
          return;
        }
        
        const fullNameInput = cartForm.querySelector('input[data-translate-placeholder="full_name"]');
        const emailInput = cartForm.querySelector('input[type="email"]');
        const additionalInfoTextarea = cartForm.querySelector('textarea');
        
        const orderData = {
          cartItems,
          totalAmount,
          fullName: fullNameInput.value.trim(),
          contactPhone: phoneInput.value.trim(),
          email: emailInput.value.trim(),
          additionalInfo: additionalInfoTextarea.value.trim()
        };
        
        const telegramSuccess = await sendCartToTelegram(orderData);
        
        if (telegramSuccess) {
          alert(getTranslatedText('order_success'));
          
          cartForm.reset();
          phoneInput.value = '';
          
          setTimeout(() => {
            window.location.href = '{% url "products" %}';
          }, 2000);
          
        } else {
          alert(getTranslatedText('order_error'));
        }
        
      } catch (error) {
        console.error('Order submission error:', error);
        alert(getTranslatedText('order_error'));
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalHTML;
      }
    });
  }

  if (typeof applyTranslations === 'function') {
    applyTranslations();
  }
});

window.updateQuantity = updateQuantity;
window.formatPhoneNumber = formatPhoneNumber;
window.sendCartToTelegram = sendCartToTelegram;
  </script>
{% endblock content %}
